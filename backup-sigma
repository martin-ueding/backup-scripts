#!/bin/bash
# Copyright (c) 2011 Martin Ueding <dev@martin-ueding.de>

set -u
set -e

logfile="$HOME/log/$(uuidgen).log"
if [[ ! -d "$(dirname "$logfile")" ]]
then
	mkdir -p "$(dirname "$logfile")"
fi

target=/media/Sigma

# Check whether the target directory is actually available.
if [ ! -d "$target" ]
then
	echo -e "ERROR: $target is not mounted"
	exit 1
fi

# Find the latest backup folder.
for backupfolder in "$target/Backup-*"
do
	lastbackupfolder="$backupfolder"
done

# Create a new folder for the current backup.
currentbackupfolder="$target/Backup-$(date +%y%m%d)"
echo "Using $currentbackupfolder as new target." >> "$logfile" 2>&1

if [[ ! -d "$currentbackupfolder" ]]
then
	mkdir "$currentbackupfolder"
fi

time rsync -avhE --delete --link-dest "$lastbackupfolder" \
	--exclude-from ~/.syncscripts/gamma_exclude.txt /home/mu/ \
	"$currentbackupfolder" >> "$logfile" 2>&1

if [[ -d "$HOME/.nag"]]
then
	touch "$HOME/.nag/Backup to Sigma"
fi
