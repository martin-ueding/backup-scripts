#!/bin/bash
# Copyright (c) 2011 Martin Ueding <dev@martin-ueding.de>

set -e
set -u

targets=("/media/Gamma/Backup" "/media/Sigma/Backup" "/media/USB-Eins/" "/media/USB-Zwei/")
for target in "${targets[@]}"
do
	if [[ -d "$target" ]]
	then
		# Print a fancy box if the tool is installed, print a simple message if
		# not.
		if which boxes > /dev/null 2>&1
		then
			echo "$target" | boxes -a c -s 80 -d shell
		else
			echo "Creating Backup to $target."
		fi


		my_rsync () {
			# If the backup volume features the small_backup flag, exclude more
			# than ususal.
			if [[ -f "$target/.small_backup" ]]
			then
				time rsync -avhE --delete \
					--exclude-from "$HOME/.syncscripts/exclude_big.txt" \
					--exclude-from "$HOME/.syncscripts/exclude_small.txt" \
					-- "$1" "$2"
			else
				time rsync -avhE --delete \
					--exclude-from "$HOME/.syncscripts/exclude_big.txt" \
					-- "$1" "$2"
			fi
		}

		set +e
		my_rsync /etc "$target/"
		my_rsync /home/mu "$target/home/"
		my_rsync /opt "$target/"
		set -e

		if which backup-status > /dev/null 2>&1
		then
			backup-status update "$target"
		fi
	fi
done

if which backup-status > /dev/null 2>&1
then
	backup-status
fi
