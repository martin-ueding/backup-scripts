#!/bin/bash
# Copyright © 2013 Martin Ueding <dev@martin-ueding.de>

set -e
set -u

shopt -s nullglob
shopt -s extglob

###############################################################################
#                                   options                                   #
###############################################################################

target="/media/Nexus"
target="$HOME/TODO"
target_music="$target/MP3"
target_pdf="$target/PDF"

dropfolder="$HOME/TODO/"

pdfdirs=(

"$HOME/Dokumente/2012-LaTeX_Kurs"
"$HOME/Dokumente/Anleitungen"
"$HOME/Dokumente/Informationen"
"$HOME/Dokumente/Nachhilfe"
"$HOME/Dokumente/Physik_Dokumente"
"$HOME/Dokumente/Studium/"Modulhandbuch_*.pdf
"$HOME/Dokumente/Studium/EBooks"
"$HOME/Dokumente/Studium/math340"
"$HOME/Dokumente/Studium/physik321"

)

###############################################################################
#                                   program                                   #
###############################################################################

if [[ -x /usr/bin/tput ]] && tput setaf 1 >&/dev/null
then
	bold="$(tput bold)"

	black="$(tput setaf 0)"
	blue="$(tput setaf 4)"
	cyan="$(tput setaf 6)"
	green="$(tput setaf 2)"
	orange="$(tput setaf 3)"
	purple="$(tput setaf 5)"
	red="$(tput setaf 1)"
	white="$(tput setaf 7)"

	reset="$(tput sgr0)"
else
	bold=

	black=
	blue=
	cyan=
	green=
	orange=
	purple=
	red=
	white=

	reset=
fi

###############################################################################
#                                program title                                #
###############################################################################

cat <<EOF
│╲   │  ┌──  ${blue}╲  ${red}╱${reset}  │   │  ╱──
│ ╲  │  │__   ${blue}╲${red}╱${reset}   │   │  ╲__
│  ╲ │  │     ${orange}╱${green}╲${reset}   │   │     ╲
│   ╲│  └── ${orange} ╱  ${green}╲${reset}  └───┘   __╱
EOF

###############################################################################
#                               copy PDF files                                #
###############################################################################

echo
echo "${cyan}Copying PDF files to Nexus${reset}"
echo

copypdf() {
	local from="$1"
	local frombase="${from#/home/*/}"
	local target="$target_pdf/${frombase}"

	echo "${cyan}Folder $from to $target${reset}"

	mkdir -p "$target"

	rsync -aEhmnv --delete --include='*.pdf' --include='*/' --exclude='*' "$from" "$target"

	echo
}

for pdfdir in "${pdfdirs[@]}"
do
	copypdf "$pdfdir"
done

exit 0

###############################################################################
#                               copy MP3 files                                #
###############################################################################

mp3-packer "$HOME/Musik/Musik/"

if [[ ! -d "$target" ]]
then
	echo -e "Error: $target is not mounted"
	exit 1
fi

if ! touch "$target/rw-test"
then
	echo "$target is writeable"
	exit 1
else
	rm "$target/rw-test"
fi

# Delete all empty files that cause trouble from the target's MP3 folder.
find "$target_music" -size 0 -delete

time rsync --max-size 15M -vr --size-only --delete --ignore-errors \
	--force --exclude-from "/home/mu/.config/syncscripts/handy_musik.txt" \
	"/home/mu/.cache/mp3_packer/128/home/mu/Musik/Musik" "$target_music"

###############################################################################
#                            update backup-status                             #
###############################################################################

backup-status update "$target"
