#!/bin/bash
# Copyright © 2013 Martin Ueding <dev@martin-ueding.de>

set -e
set -u

shopt -s nullglob
shopt -s extglob

###############################################################################
#                                   options                                   #
###############################################################################

pdfdirs=(

"$HOME/Dokumente/2012-LaTeX_Kurs"
"$HOME/Dokumente/Anleitungen"
"$HOME/Dokumente/Aufsaetze/Brandon_Patrick_In_Space"
"$HOME/Dokumente/Informationen"
"$HOME/Dokumente/Nachhilfe"
"$HOME/Dokumente/Physik_Dokumente"
"$HOME/Dokumente/Schule/Abizeitung/Abizeitung.pdf"
"$HOME/Dokumente/Spektrum"
"$HOME/Dokumente/Studium/"Modulhandbuch_*.pdf
"$HOME/Dokumente/Studium/EBooks"
"$HOME/Dokumente/Studium/math340"
"$HOME/Dokumente/Studium/physik312"
"$HOME/Dokumente/Studium/physik321"

)

bins=(

DCIM/Camera
Download
TODO

)

ips=(

"192.168.100.101"
"192.168.100.106"

)

###############################################################################
#                                   program                                   #
###############################################################################

myrsync() {
	rsync --rsh="ssh -p $port" --progress -hlmrv --size-only --ignore-errors "$@"
}

copypdf() {
	local from="$1"
	local frombase="${from#/home/*/}"
	local target="$target_pdf/${frombase%/*}"

	echo "${cyan}Folder $from to $target${reset}"

	ssh -p "$port" "$ip" "mkdir -p \"${target#*:}\""
	myrsync --delete --include='*.pdf' --include='*/' --exclude='*' "$from" "$target/"

	echo
}

movetocomputer() {
	folder="$1"

	printheading "move $folder to computer"

	myrsync "$target/$folder/" "$dropfolder"
	ssh -p 2222 "$ip" "rm -frv /sdcard/$folder/*"
}

printheading() {
	echo
	echo "${green}$1${reset}"
	echo
}

if [[ -x /usr/bin/tput ]] && tput setaf 1 >&/dev/null
then
	bold="$(tput bold)"

	black="$(tput setaf 0)"
	blue="$(tput setaf 4)"
	cyan="$(tput setaf 6)"
	green="$(tput setaf 2)"
	orange="$(tput setaf 3)"
	purple="$(tput setaf 5)"
	red="$(tput setaf 1)"
	white="$(tput setaf 7)"

	reset="$(tput sgr0)"
else
	bold=

	black=
	blue=
	cyan=
	green=
	orange=
	purple=
	red=
	white=

	reset=
fi

print-nexus() {
	cat <<<EOF
	│╲   │  ┌──  ${blue}╲  ${red}╱${reset}  │   │  ╱──
	│ ╲  │  │__   ${blue}╲${red}╱${reset}   │   │  ╲__
	│  ╲ │  │     ${orange}╱${green}╲${reset}   │   │     ╲
	│   ╲│  └── ${orange} ╱  ${green}╲${reset}  └───┘   __╱
	EOF
}

ping-test() {
	ping -c 1 -w 2 "$ip" &> /dev/null
}

sync-device() {
	echo "${bold}Syncing $ip${reset}"

	if ! ping-test
	then
		echo "${red}Device is not reachable. Aborting.${reset}"
		return
	fi

	port="2222"
	target="$ip:/sdcard"
	target_music="$target/Music"
	target_pdf="$target/PDF"

	dropfolder="$HOME/TODO"

	printheading "copying PDF files to device"
	for pdfdir in "${pdfdirs[@]}"
	do
		copypdf "$pdfdir"
	done

	for bin in "${bins[@]}"
	do
		movetocomputer "$bin"
	done

	printheading "Copying MP3 files to device"
	myrsync --delete --max-size 15M \
		--force --exclude-from "/home/mu/.config/syncscripts/handy_musik.txt" \
		"/home/mu/.cache/mp3_packer/128/home/mu/Musik/Musik/" "$target_music/"

	backup-status update "$target"
}

for ip in "${ips[@]}"
do
	sync-device
done
